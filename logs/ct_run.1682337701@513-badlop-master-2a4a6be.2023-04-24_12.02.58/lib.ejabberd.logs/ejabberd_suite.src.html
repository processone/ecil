<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/home/runner/work/ejabberd/ejabberd/_build/test/lib/ejabberd/test/ejabberd_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%%-------------------------------------------------------------------</i>
<a name="2"/>    2: <i>%%% Author  : Evgeny Khramtsov &lt;ekhramtsov@process-one.net&gt;</i>
<a name="3"/>    3: <i>%%% Created :  2 Jun 2013 by Evgeniy Khramtsov &lt;ekhramtsov@process-one.net&gt;</i>
<a name="4"/>    4: <i>%%%</i>
<a name="5"/>    5: <i>%%%</i>
<a name="6"/>    6: <i>%%% ejabberd, Copyright (C) 2002-2023   ProcessOne</i>
<a name="7"/>    7: <i>%%%</i>
<a name="8"/>    8: <i>%%% This program is free software; you can redistribute it and/or</i>
<a name="9"/>    9: <i>%%% modify it under the terms of the GNU General Public License as</i>
<a name="10"/>   10: <i>%%% published by the Free Software Foundation; either version 2 of the</i>
<a name="11"/>   11: <i>%%% License, or (at your option) any later version.</i>
<a name="12"/>   12: <i>%%%</i>
<a name="13"/>   13: <i>%%% This program is distributed in the hope that it will be useful,</i>
<a name="14"/>   14: <i>%%% but WITHOUT ANY WARRANTY; without even the implied warranty of</i>
<a name="15"/>   15: <i>%%% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</i>
<a name="16"/>   16: <i>%%% General Public License for more details.</i>
<a name="17"/>   17: <i>%%%</i>
<a name="18"/>   18: <i>%%% You should have received a copy of the GNU General Public License along</i>
<a name="19"/>   19: <i>%%% with this program; if not, write to the Free Software Foundation, Inc.,</i>
<a name="20"/>   20: <i>%%% 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</i>
<a name="21"/>   21: <i>%%%</i>
<a name="22"/>   22: <i>%%%----------------------------------------------------------------------</i>
<a name="23"/>   23: <b>-module</b>(ejabberd_SUITE).
<a name="24"/>   24: <b>-compile</b>(export_all).
<a name="25"/>   25: 
<a name="26"/>   26: <b>-import</b>(suite, [init_config/1, connect/1, disconnect/1, recv_message/1,
<a name="27"/>   27:                 recv/1, recv_presence/1, send/2, send_recv/2, my_jid/1,
<a name="28"/>   28: 		server_jid/1, pubsub_jid/1, proxy_jid/1, muc_jid/1,
<a name="29"/>   29: 		muc_room_jid/1, my_muc_jid/1, peer_muc_jid/1,
<a name="30"/>   30: 		mix_jid/1, mix_room_jid/1, get_features/2, recv_iq/1,
<a name="31"/>   31: 		re_register/1, is_feature_advertised/2, subscribe_to_events/1,
<a name="32"/>   32:                 is_feature_advertised/3, set_opt/3,
<a name="33"/>   33: 		auth_SASL/2, auth_SASL/3, auth_SASL/4,
<a name="34"/>   34:                 wait_for_master/1, wait_for_slave/1, flush/1,
<a name="35"/>   35:                 make_iq_result/1, start_event_relay/0, alt_room_jid/1,
<a name="36"/>   36:                 stop_event_relay/1, put_event/2, get_event/1,
<a name="37"/>   37:                 bind/1, auth/1, auth/2, open_session/1, open_session/2,
<a name="38"/>   38: 		zlib/1, starttls/1, starttls/2, close_socket/1, init_stream/1,
<a name="39"/>   39: 		auth_legacy/2, auth_legacy/3, tcp_connect/1, send_text/2,
<a name="40"/>   40: 		set_roster/3, del_roster/1]).
<a name="41"/>   41: <b>-include</b>(&quot;suite.hrl&quot;).
<a name="42"/>   42: 
<a name="suite-0"/><a name="43"/>   43: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="44"/>   44:     [{timetrap, {seconds, 120}}].
<a name="45"/>   45: 
<a name="init_per_suite-1"/><a name="46"/>   46: <b>init_per_suite</b>(Config) -&gt;
<a name="47"/>   47:     NewConfig = init_config(Config),
<a name="48"/>   48:     DataDir = proplists:get_value(data_dir, NewConfig),
<a name="49"/>   49:     {ok, CWD} = file:get_cwd(),
<a name="50"/>   50:     ExtAuthScript = filename:join([DataDir, &quot;extauth.py&quot;]),
<a name="51"/>   51:     LDIFFile = filename:join([DataDir, &quot;ejabberd.ldif&quot;]),
<a name="52"/>   52:     {ok, _} = file:copy(ExtAuthScript, filename:join([CWD, &quot;extauth.py&quot;])),
<a name="53"/>   53:     {ok, _} = ldap_srv:start(LDIFFile),
<a name="54"/>   54:     inet_db:add_host({127,0,0,1}, [binary_to_list(?S2S_VHOST),
<a name="55"/>   55: 				   binary_to_list(?MNESIA_VHOST),
<a name="56"/>   56: 				   binary_to_list(?UPLOAD_VHOST)]),
<a name="57"/>   57:     inet_db:set_domain(binary_to_list(p1_rand:get_string())),
<a name="58"/>   58:     inet_db:set_lookup([file, native]),
<a name="59"/>   59:     start_ejabberd(NewConfig),
<a name="init_per_suite-last_expr"/><a name="60"/>   60:     NewConfig.
<a name="61"/>   61: 
<a name="start_ejabberd-1"/><a name="62"/>   62: <b>start_ejabberd</b>(_) -&gt;
<a name="start_ejabberd-last_expr"/><a name="63"/>   63: <b>    {ok, _} = application:ensure_all_started</b>(ejabberd, transient).
<a name="64"/>   64: 
<a name="end_per_suite-1"/><a name="65"/>   65: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="66"/>   66: <b>    application:stop</b>(ejabberd).
<a name="67"/>   67: 
<a name="init_per_group-2"/><a name="68"/>   68: <b>init_per_group</b>(Group, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="69"/>   69: <b>    case lists:member</b>(Group, ?BACKENDS) of
<a name="70"/>   70:         false -&gt;
<a name="71"/>   71:             %% Not a backend related group, do default init:
<a name="72"/>   72:             do_init_per_group(Group, Config);
<a name="73"/>   73:         true -&gt;
<a name="74"/>   74:             case proplists:get_value(backends, Config) of
<a name="75"/>   75:                 all -&gt;
<a name="76"/>   76:                     %% All backends enabled
<a name="77"/>   77:                     do_init_per_group(Group, Config);
<a name="78"/>   78:                 Backends -&gt;
<a name="79"/>   79:                     %% Skipped backends that were not explicitly enabled
<a name="80"/>   80: 		    case lists:member(Group, Backends) of
<a name="81"/>   81: 			true -&gt;
<a name="82"/>   82: 			    do_init_per_group(Group, Config);
<a name="83"/>   83: 			false -&gt;
<a name="84"/>   84: 			    {skip, {disabled_backend, Group}}
<a name="85"/>   85: 		    end
<a name="86"/>   86:             end
<a name="87"/>   87:     end.
<a name="88"/>   88: 
<a name="do_init_per_group-2"/><a name="89"/>   89: <b>do_init_per_group</b>(no_db, Config) -&gt;
<a name="90"/>   90:     re_register(Config),
<a name="91"/>   91:     set_opt(persistent_room, false, Config);
<a name="92"/>   92: <b>do_init_per_group</b>(mnesia, Config) -&gt;
<a name="93"/>   93:     mod_muc:shutdown_rooms(?MNESIA_VHOST),
<a name="94"/>   94:     set_opt(server, ?MNESIA_VHOST, Config);
<a name="95"/>   95: <b>do_init_per_group</b>(redis, Config) -&gt;
<a name="96"/>   96:     mod_muc:shutdown_rooms(?REDIS_VHOST),
<a name="97"/>   97:     set_opt(server, ?REDIS_VHOST, Config);
<a name="98"/>   98: <b>do_init_per_group</b>(mysql, Config) -&gt;
<a name="99"/>   99:     case catch ejabberd_sql:sql_query(?MYSQL_VHOST, [&lt;&lt;&quot;select 1;&quot;&gt;&gt;]) of
<a name="100"/>  100:         {selected, _, _} -&gt;
<a name="101"/>  101:             mod_muc:shutdown_rooms(?MYSQL_VHOST),
<a name="102"/>  102:             clear_sql_tables(mysql, Config),
<a name="103"/>  103:             update_sql(?MYSQL_VHOST, Config),
<a name="104"/>  104:             set_opt(server, ?MYSQL_VHOST, Config);
<a name="105"/>  105:         Err -&gt;
<a name="106"/>  106:             {skip, {mysql_not_available, Err}}
<a name="107"/>  107:     end;
<a name="108"/>  108: <b>do_init_per_group</b>(mssql, Config) -&gt;
<a name="109"/>  109:     case catch ejabberd_sql:sql_query(?MSSQL_VHOST, [&lt;&lt;&quot;select 1;&quot;&gt;&gt;]) of
<a name="110"/>  110:         {selected, _, _} -&gt;
<a name="111"/>  111:             mod_muc:shutdown_rooms(?MSSQL_VHOST),
<a name="112"/>  112:             clear_sql_tables(mssql, Config),
<a name="113"/>  113:             update_sql(?MSSQL_VHOST, Config),
<a name="114"/>  114:             set_opt(server, ?MSSQL_VHOST, Config);
<a name="115"/>  115:         Err -&gt;
<a name="116"/>  116:             {skip, {mssql_not_available, Err}}
<a name="117"/>  117:     end;
<a name="118"/>  118: <b>do_init_per_group</b>(pgsql, Config) -&gt;
<a name="119"/>  119:     case catch ejabberd_sql:sql_query(?PGSQL_VHOST, [&lt;&lt;&quot;select 1;&quot;&gt;&gt;]) of
<a name="120"/>  120:         {selected, _, _} -&gt;
<a name="121"/>  121:             mod_muc:shutdown_rooms(?PGSQL_VHOST),
<a name="122"/>  122:             clear_sql_tables(pgsql, Config),
<a name="123"/>  123:             update_sql(?PGSQL_VHOST, Config),
<a name="124"/>  124:             set_opt(server, ?PGSQL_VHOST, Config);
<a name="125"/>  125:         Err -&gt;
<a name="126"/>  126:             {skip, {pgsql_not_available, Err}}
<a name="127"/>  127:     end;
<a name="128"/>  128: <b>do_init_per_group</b>(sqlite, Config) -&gt;
<a name="129"/>  129:     case catch ejabberd_sql:sql_query(?SQLITE_VHOST, [&lt;&lt;&quot;select 1;&quot;&gt;&gt;]) of
<a name="130"/>  130:         {selected, _, _} -&gt;
<a name="131"/>  131:             mod_muc:shutdown_rooms(?SQLITE_VHOST),
<a name="132"/>  132:             set_opt(server, ?SQLITE_VHOST, Config);
<a name="133"/>  133:         Err -&gt;
<a name="134"/>  134:             {skip, {sqlite_not_available, Err}}
<a name="135"/>  135:     end;
<a name="136"/>  136: <b>do_init_per_group</b>(ldap, Config) -&gt;
<a name="137"/>  137:     set_opt(server, ?LDAP_VHOST, Config);
<a name="138"/>  138: <b>do_init_per_group</b>(extauth, Config) -&gt;
<a name="139"/>  139:     set_opt(server, ?EXTAUTH_VHOST, Config);
<a name="140"/>  140: <b>do_init_per_group</b>(s2s, Config) -&gt;
<a name="141"/>  141:     ejabberd_config:set_option({s2s_use_starttls, ?COMMON_VHOST}, required),
<a name="142"/>  142:     ejabberd_config:set_option(ca_file, &quot;ca.pem&quot;),
<a name="143"/>  143:     Port = ?config(s2s_port, Config),
<a name="144"/>  144:     set_opt(server, ?COMMON_VHOST,
<a name="145"/>  145: 	    set_opt(xmlns, ?NS_SERVER,
<a name="146"/>  146: 		    set_opt(type, server,
<a name="147"/>  147: 			    set_opt(server_port, Port,
<a name="148"/>  148: 				    set_opt(stream_from, ?S2S_VHOST,
<a name="149"/>  149: 					    set_opt(lang, &lt;&lt;&quot;&quot;&gt;&gt;, Config))))));
<a name="150"/>  150: <b>do_init_per_group</b>(component, Config) -&gt;
<a name="151"/>  151:     Server = ?config(server, Config),
<a name="152"/>  152:     Port = ?config(component_port, Config),
<a name="153"/>  153:     set_opt(xmlns, ?NS_COMPONENT,
<a name="154"/>  154:             set_opt(server, &lt;&lt;&quot;component.&quot;, Server/binary&gt;&gt;,
<a name="155"/>  155:                     set_opt(type, component,
<a name="156"/>  156:                             set_opt(server_port, Port,
<a name="157"/>  157:                                     set_opt(stream_version, undefined,
<a name="158"/>  158:                                             set_opt(lang, &lt;&lt;&quot;&quot;&gt;&gt;, Config))))));
<a name="159"/>  159: <b>do_init_per_group</b>(GroupName, Config) -&gt;
<a name="160"/>  160:     Pid = start_event_relay(),
<a name="161"/>  161:     NewConfig = set_opt(event_relay, Pid, Config),
<a name="do_init_per_group-last_expr"/><a name="162"/>  162:     case GroupName of
<a name="163"/>  163: 	anonymous -&gt; set_opt(anonymous, true, NewConfig);
<a name="164"/>  164: 	_ -&gt; NewConfig
<a name="165"/>  165:     end.
<a name="166"/>  166: 
<a name="end_per_group-2"/><a name="167"/>  167: <b>end_per_group</b>(mnesia, _Config) -&gt;
<a name="168"/>  168:     ok;
<a name="169"/>  169: <b>end_per_group</b>(redis, _Config) -&gt;
<a name="170"/>  170:     ok;
<a name="171"/>  171: <b>end_per_group</b>(mysql, _Config) -&gt;
<a name="172"/>  172:     ok;
<a name="173"/>  173: <b>end_per_group</b>(mssql, _Config) -&gt;
<a name="174"/>  174:     ok;
<a name="175"/>  175: <b>end_per_group</b>(pgsql, _Config) -&gt;
<a name="176"/>  176:     ok;
<a name="177"/>  177: <b>end_per_group</b>(sqlite, _Config) -&gt;
<a name="178"/>  178:     ok;
<a name="179"/>  179: <b>end_per_group</b>(no_db, _Config) -&gt;
<a name="180"/>  180:     ok;
<a name="181"/>  181: <b>end_per_group</b>(ldap, _Config) -&gt;
<a name="182"/>  182:     ok;
<a name="183"/>  183: <b>end_per_group</b>(extauth, _Config) -&gt;
<a name="184"/>  184:     ok;
<a name="185"/>  185: <b>end_per_group</b>(component, _Config) -&gt;
<a name="186"/>  186:     ok;
<a name="187"/>  187: <b>end_per_group</b>(s2s, Config) -&gt;
<a name="188"/>  188:     Server = ?config(server, Config),
<a name="189"/>  189:     ejabberd_config:set_option({s2s_use_starttls, Server}, false);
<a name="190"/>  190: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="191"/>  191:     stop_event_relay(Config),
<a name="end_per_group-last_expr"/><a name="192"/>  192: <b>    set_opt</b>(anonymous, false, Config).
<a name="193"/>  193: 
<a name="init_per_testcase-2"/><a name="194"/>  194: <b>init_per_testcase</b>(stop_ejabberd, Config) -&gt;
<a name="195"/>  195:     NewConfig = set_opt(resource, &lt;&lt;&quot;&quot;&gt;&gt;,
<a name="196"/>  196: 			set_opt(anonymous, true, Config)),
<a name="197"/>  197:     open_session(bind(auth(connect(NewConfig))));
<a name="198"/>  198: <b>init_per_testcase</b>(TestCase, OrigConfig) -&gt;
<a name="199"/>  199:     ct:print(80, &quot;Testcase '~p' starting&quot;, [TestCase]),
<a name="200"/>  200:     Test = atom_to_list(TestCase),
<a name="201"/>  201:     IsMaster = lists:suffix(&quot;_master&quot;, Test),
<a name="202"/>  202:     IsSlave = lists:suffix(&quot;_slave&quot;, Test),
<a name="203"/>  203:     if IsMaster or IsSlave -&gt;
<a name="204"/>  204: 	    subscribe_to_events(OrigConfig);
<a name="205"/>  205:        true -&gt;
<a name="206"/>  206: 	    ok
<a name="207"/>  207:     end,
<a name="208"/>  208:     TestGroup = proplists:get_value(
<a name="209"/>  209: 		  name, ?config(tc_group_properties, OrigConfig)),
<a name="210"/>  210:     Server = ?config(server, OrigConfig),
<a name="211"/>  211:     Resource = case TestGroup of
<a name="212"/>  212: 		   anonymous -&gt;
<a name="213"/>  213: 		       &lt;&lt;&quot;&quot;&gt;&gt;;
<a name="214"/>  214: 		   legacy_auth -&gt;
<a name="215"/>  215: 		       p1_rand:get_string();
<a name="216"/>  216: 		   _ -&gt;
<a name="217"/>  217: 		       ?config(resource, OrigConfig)
<a name="218"/>  218: 	       end,
<a name="219"/>  219:     MasterResource = ?config(master_resource, OrigConfig),
<a name="220"/>  220:     SlaveResource = ?config(slave_resource, OrigConfig),
<a name="221"/>  221:     Mode = if IsSlave -&gt; slave;
<a name="222"/>  222: 	      IsMaster -&gt; master;
<a name="223"/>  223: 	      true -&gt; single
<a name="224"/>  224: 	   end,
<a name="225"/>  225:     IsCarbons = lists:prefix(&quot;carbons_&quot;, Test),
<a name="226"/>  226:     IsReplaced = lists:prefix(&quot;replaced_&quot;, Test),
<a name="227"/>  227:     User = if IsReplaced -&gt; &lt;&lt;&quot;test_single!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;;
<a name="228"/>  228: 	      IsCarbons and not (IsMaster or IsSlave) -&gt;
<a name="229"/>  229: 		   &lt;&lt;&quot;test_single!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;;
<a name="230"/>  230: 	      IsMaster or IsCarbons -&gt; &lt;&lt;&quot;test_master!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;;
<a name="231"/>  231:               IsSlave -&gt; &lt;&lt;&quot;test_slave!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;;
<a name="232"/>  232:               true -&gt; &lt;&lt;&quot;test_single!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;
<a name="233"/>  233:            end,
<a name="234"/>  234:     Nick = if IsSlave -&gt; ?config(slave_nick, OrigConfig);
<a name="235"/>  235: 	      IsMaster -&gt; ?config(master_nick, OrigConfig);
<a name="236"/>  236: 	      true -&gt; ?config(nick, OrigConfig)
<a name="237"/>  237: 	   end,
<a name="238"/>  238:     MyResource = if IsMaster and IsCarbons -&gt; MasterResource;
<a name="239"/>  239: 		    IsSlave and IsCarbons -&gt; SlaveResource;
<a name="240"/>  240: 		    true -&gt; Resource
<a name="241"/>  241: 		 end,
<a name="242"/>  242:     Slave = if IsCarbons -&gt;
<a name="243"/>  243: 		    jid:make(&lt;&lt;&quot;test_master!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;, Server, SlaveResource);
<a name="244"/>  244: 	       IsReplaced -&gt;
<a name="245"/>  245: 		    jid:make(User, Server, Resource);
<a name="246"/>  246: 	       true -&gt;
<a name="247"/>  247: 		    jid:make(&lt;&lt;&quot;test_slave!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;, Server, Resource)
<a name="248"/>  248: 	    end,
<a name="249"/>  249:     Master = if IsCarbons -&gt;
<a name="250"/>  250: 		     jid:make(&lt;&lt;&quot;test_master!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;, Server, MasterResource);
<a name="251"/>  251: 		IsReplaced -&gt;
<a name="252"/>  252: 		     jid:make(User, Server, Resource);
<a name="253"/>  253: 		true -&gt;
<a name="254"/>  254: 		     jid:make(&lt;&lt;&quot;test_master!#$%^*()`~+-;_=[]{}|\\&quot;&gt;&gt;, Server, Resource)
<a name="255"/>  255: 	     end,
<a name="256"/>  256:     Config1 = set_opt(user, User,
<a name="257"/>  257: 		      set_opt(slave, Slave,
<a name="258"/>  258: 			      set_opt(master, Master,
<a name="259"/>  259: 				      set_opt(resource, MyResource,
<a name="260"/>  260: 					      set_opt(nick, Nick,
<a name="261"/>  261: 						      set_opt(mode, Mode, OrigConfig)))))),
<a name="262"/>  262:     Config2 = if IsSlave -&gt;
<a name="263"/>  263: 		      set_opt(peer_nick, ?config(master_nick, Config1), Config1);
<a name="264"/>  264: 		 IsMaster -&gt;
<a name="265"/>  265: 		      set_opt(peer_nick, ?config(slave_nick, Config1), Config1);
<a name="266"/>  266: 		 true -&gt;
<a name="267"/>  267: 		      Config1
<a name="268"/>  268: 	      end,
<a name="269"/>  269:     Config = if IsSlave -&gt; set_opt(peer, Master, Config2);
<a name="270"/>  270: 		IsMaster -&gt; set_opt(peer, Slave, Config2);
<a name="271"/>  271: 		true -&gt; Config2
<a name="272"/>  272: 	     end,
<a name="init_per_testcase-last_expr"/><a name="273"/>  273:     case Test of
<a name="274"/>  274:         &quot;test_connect&quot; ++ _ -&gt;
<a name="275"/>  275:             Config;
<a name="276"/>  276:         &quot;webadmin_&quot; ++ _ -&gt;
<a name="277"/>  277:             Config;
<a name="278"/>  278: 	&quot;test_legacy_auth_feature&quot; -&gt;
<a name="279"/>  279: 	    connect(Config);
<a name="280"/>  280: 	&quot;test_legacy_auth&quot; ++ _ -&gt;
<a name="281"/>  281: 	    init_stream(set_opt(stream_version, undefined, Config));
<a name="282"/>  282:         &quot;test_auth&quot; ++ _ -&gt;
<a name="283"/>  283:             connect(Config);
<a name="284"/>  284:         &quot;test_starttls&quot; ++ _ -&gt;
<a name="285"/>  285:             connect(Config);
<a name="286"/>  286:         &quot;test_zlib&quot; -&gt;
<a name="287"/>  287:             auth(connect(starttls(connect(Config))));
<a name="288"/>  288:         &quot;test_register&quot; -&gt;
<a name="289"/>  289:             connect(Config);
<a name="290"/>  290:         &quot;auth_md5&quot; -&gt;
<a name="291"/>  291:             connect(Config);
<a name="292"/>  292:         &quot;auth_plain&quot; -&gt;
<a name="293"/>  293:             connect(Config);
<a name="294"/>  294: 	&quot;auth_external&quot; ++ _ -&gt;
<a name="295"/>  295: 	    connect(Config);
<a name="296"/>  296: 	&quot;unauthenticated_&quot; ++ _ -&gt;
<a name="297"/>  297: 	    connect(Config);
<a name="298"/>  298:         &quot;test_bind&quot; -&gt;
<a name="299"/>  299:             auth(connect(Config));
<a name="300"/>  300: 	&quot;sm_resume&quot; -&gt;
<a name="301"/>  301: 	    auth(connect(Config));
<a name="302"/>  302: 	&quot;sm_resume_failed&quot; -&gt;
<a name="303"/>  303: 	    auth(connect(Config));
<a name="304"/>  304:         &quot;test_open_session&quot; -&gt;
<a name="305"/>  305:             bind(auth(connect(Config)));
<a name="306"/>  306: 	&quot;replaced&quot; ++ _ -&gt;
<a name="307"/>  307: 	    auth(connect(Config));
<a name="308"/>  308:         _ when IsMaster or IsSlave -&gt;
<a name="309"/>  309:             Password = ?config(password, Config),
<a name="310"/>  310:             ejabberd_auth:try_register(User, Server, Password),
<a name="311"/>  311:             open_session(bind(auth(connect(Config))));
<a name="312"/>  312: 	_ when TestGroup == s2s_tests -&gt;
<a name="313"/>  313: 	    auth(connect(starttls(connect(Config))));
<a name="314"/>  314:         _ -&gt;
<a name="315"/>  315:             open_session(bind(auth(connect(Config))))
<a name="316"/>  316:     end.
<a name="317"/>  317: 
<a name="end_per_testcase-2"/><a name="318"/>  318: <b>end_per_testcase</b>(_TestCase, _Config) -&gt;
<a name="end_per_testcase-last_expr"/><a name="319"/>  319:     ok.
<a name="320"/>  320: 
<a name="legacy_auth_tests-0"/><a name="321"/>  321: <b>legacy_auth_tests</b>() -&gt;
<a name="legacy_auth_tests-last_expr"/><a name="322"/>  322:     {legacy_auth, [parallel],
<a name="323"/>  323:      [test_legacy_auth_feature,
<a name="324"/>  324:       test_legacy_auth,
<a name="325"/>  325:       test_legacy_auth_digest,
<a name="326"/>  326:       test_legacy_auth_no_resource,
<a name="327"/>  327:       test_legacy_auth_bad_jid,
<a name="328"/>  328:       test_legacy_auth_fail]}.
<a name="329"/>  329: 
<a name="no_db_tests-0"/><a name="330"/>  330: <b>no_db_tests</b>() -&gt;
<a name="no_db_tests-last_expr"/><a name="331"/>  331:     [{anonymous, [parallel],
<a name="332"/>  332:       [test_connect_bad_xml,
<a name="333"/>  333:        test_connect_unexpected_xml,
<a name="334"/>  334:        test_connect_unknown_ns,
<a name="335"/>  335:        test_connect_bad_xmlns,
<a name="336"/>  336:        test_connect_bad_ns_stream,
<a name="337"/>  337:        test_connect_bad_lang,
<a name="338"/>  338:        test_connect_bad_to,
<a name="339"/>  339:        test_connect_missing_to,
<a name="340"/>  340:        test_connect,
<a name="341"/>  341:        unauthenticated_iq,
<a name="342"/>  342:        unauthenticated_message,
<a name="343"/>  343:        unauthenticated_presence,
<a name="344"/>  344:        test_starttls,
<a name="345"/>  345:        test_auth,
<a name="346"/>  346:        test_zlib,
<a name="347"/>  347:        test_bind,
<a name="348"/>  348:        test_open_session,
<a name="349"/>  349:        codec_failure,
<a name="350"/>  350:        unsupported_query,
<a name="351"/>  351:        bad_nonza,
<a name="352"/>  352:        invalid_from,
<a name="353"/>  353:        ping,
<a name="354"/>  354:        version,
<a name="355"/>  355:        time,
<a name="356"/>  356:        stats,
<a name="357"/>  357:        disco]},
<a name="358"/>  358:      {presence_and_s2s, [sequence],
<a name="359"/>  359:       [test_auth_fail,
<a name="360"/>  360:        presence,
<a name="361"/>  361:        s2s_dialback,
<a name="362"/>  362:        s2s_optional,
<a name="363"/>  363:        s2s_required]},
<a name="364"/>  364:      auth_external,
<a name="365"/>  365:      auth_external_no_jid,
<a name="366"/>  366:      auth_external_no_user,
<a name="367"/>  367:      auth_external_malformed_jid,
<a name="368"/>  368:      auth_external_wrong_jid,
<a name="369"/>  369:      auth_external_wrong_server,
<a name="370"/>  370:      auth_external_invalid_cert,
<a name="371"/>  371:      jidprep_tests:single_cases(),
<a name="372"/>  372:      sm_tests:single_cases(),
<a name="373"/>  373:      sm_tests:master_slave_cases(),
<a name="374"/>  374:      muc_tests:single_cases(),
<a name="375"/>  375:      muc_tests:master_slave_cases(),
<a name="376"/>  376:      proxy65_tests:single_cases(),
<a name="377"/>  377:      proxy65_tests:master_slave_cases(),
<a name="378"/>  378:      stundisco_tests:single_cases(),
<a name="379"/>  379:      replaced_tests:master_slave_cases(),
<a name="380"/>  380:      upload_tests:single_cases(),
<a name="381"/>  381:      carbons_tests:single_cases(),
<a name="382"/>  382:      carbons_tests:master_slave_cases()].
<a name="383"/>  383: 
<a name="db_tests-1"/><a name="384"/>  384: <b>db_tests</b>(DB) when DB == mnesia; DB == redis -&gt;
<a name="385"/>  385:     [{single_user, [sequence],
<a name="386"/>  386:       [test_register,
<a name="387"/>  387:        legacy_auth_tests(),
<a name="388"/>  388:        auth_plain,
<a name="389"/>  389:        auth_md5,
<a name="390"/>  390:        presence_broadcast,
<a name="391"/>  391:        last,
<a name="392"/>  392:        webadmin_tests:single_cases(),
<a name="393"/>  393:        roster_tests:single_cases(),
<a name="394"/>  394:        private_tests:single_cases(),
<a name="395"/>  395:        privacy_tests:single_cases(),
<a name="396"/>  396:        vcard_tests:single_cases(),
<a name="397"/>  397:        pubsub_tests:single_cases(),
<a name="398"/>  398:        muc_tests:single_cases(),
<a name="399"/>  399:        offline_tests:single_cases(),
<a name="400"/>  400:        mam_tests:single_cases(),
<a name="401"/>  401:        csi_tests:single_cases(),
<a name="402"/>  402:        push_tests:single_cases(),
<a name="403"/>  403:        test_unregister]},
<a name="404"/>  404:      muc_tests:master_slave_cases(),
<a name="405"/>  405:      privacy_tests:master_slave_cases(),
<a name="406"/>  406:      pubsub_tests:master_slave_cases(),
<a name="407"/>  407:      roster_tests:master_slave_cases(),
<a name="408"/>  408:      offline_tests:master_slave_cases(DB),
<a name="409"/>  409:      mam_tests:master_slave_cases(),
<a name="410"/>  410:      vcard_tests:master_slave_cases(),
<a name="411"/>  411:      announce_tests:master_slave_cases(),
<a name="412"/>  412:      csi_tests:master_slave_cases(),
<a name="413"/>  413:      push_tests:master_slave_cases()];
<a name="414"/>  414: <b>db_tests</b>(DB) -&gt;
<a name="db_tests-last_expr"/><a name="415"/>  415:     [{single_user, [sequence],
<a name="416"/>  416:       [test_register,
<a name="417"/>  417:        legacy_auth_tests(),
<a name="418"/>  418:        auth_plain,
<a name="419"/>  419:        auth_md5,
<a name="420"/>  420:        presence_broadcast,
<a name="421"/>  421:        last,
<a name="422"/>  422:        webadmin_tests:single_cases(),
<a name="423"/>  423:        roster_tests:single_cases(),
<a name="424"/>  424:        private_tests:single_cases(),
<a name="425"/>  425:        privacy_tests:single_cases(),
<a name="426"/>  426:        vcard_tests:single_cases(),
<a name="427"/>  427:        pubsub_tests:single_cases(),
<a name="428"/>  428:        muc_tests:single_cases(),
<a name="429"/>  429:        offline_tests:single_cases(),
<a name="430"/>  430:        mam_tests:single_cases(),
<a name="431"/>  431:        push_tests:single_cases(),
<a name="432"/>  432:        test_unregister]},
<a name="433"/>  433:      muc_tests:master_slave_cases(),
<a name="434"/>  434:      privacy_tests:master_slave_cases(),
<a name="435"/>  435:      pubsub_tests:master_slave_cases(),
<a name="436"/>  436:      roster_tests:master_slave_cases(),
<a name="437"/>  437:      offline_tests:master_slave_cases(DB),
<a name="438"/>  438:      mam_tests:master_slave_cases(),
<a name="439"/>  439:      vcard_tests:master_slave_cases(),
<a name="440"/>  440:      announce_tests:master_slave_cases(),
<a name="441"/>  441:      push_tests:master_slave_cases()].
<a name="442"/>  442: 
<a name="ldap_tests-0"/><a name="443"/>  443: <b>ldap_tests</b>() -&gt;
<a name="ldap_tests-last_expr"/><a name="444"/>  444:     [{ldap_tests, [sequence],
<a name="445"/>  445:       [test_auth,
<a name="446"/>  446:        test_auth_fail,
<a name="447"/>  447:        vcard_get,
<a name="448"/>  448:        ldap_shared_roster_get]}].
<a name="449"/>  449: 
<a name="extauth_tests-0"/><a name="450"/>  450: <b>extauth_tests</b>() -&gt;
<a name="extauth_tests-last_expr"/><a name="451"/>  451:     [{extauth_tests, [sequence],
<a name="452"/>  452:       [test_auth,
<a name="453"/>  453:        test_auth_fail,
<a name="454"/>  454:        test_unregister]}].
<a name="455"/>  455: 
<a name="component_tests-0"/><a name="456"/>  456: <b>component_tests</b>() -&gt;
<a name="component_tests-last_expr"/><a name="457"/>  457:     [{component_connect, [parallel],
<a name="458"/>  458:       [test_connect_bad_xml,
<a name="459"/>  459:        test_connect_unexpected_xml,
<a name="460"/>  460:        test_connect_unknown_ns,
<a name="461"/>  461:        test_connect_bad_xmlns,
<a name="462"/>  462:        test_connect_bad_ns_stream,
<a name="463"/>  463:        test_connect_missing_to,
<a name="464"/>  464:        test_connect,
<a name="465"/>  465:        test_auth,
<a name="466"/>  466:        test_auth_fail]},
<a name="467"/>  467:      {component_tests, [sequence],
<a name="468"/>  468:       [test_missing_from,
<a name="469"/>  469:        test_missing_to,
<a name="470"/>  470:        test_invalid_from,
<a name="471"/>  471:        test_component_send,
<a name="472"/>  472:        bad_nonza,
<a name="473"/>  473:        codec_failure]}].
<a name="474"/>  474: 
<a name="s2s_tests-0"/><a name="475"/>  475: <b>s2s_tests</b>() -&gt;
<a name="s2s_tests-last_expr"/><a name="476"/>  476:     [{s2s_connect, [parallel],
<a name="477"/>  477:       [test_connect_bad_xml,
<a name="478"/>  478:        test_connect_unexpected_xml,
<a name="479"/>  479:        test_connect_unknown_ns,
<a name="480"/>  480:        test_connect_bad_xmlns,
<a name="481"/>  481:        test_connect_bad_ns_stream,
<a name="482"/>  482:        test_connect,
<a name="483"/>  483:        test_connect_s2s_starttls_required,
<a name="484"/>  484:        test_starttls,
<a name="485"/>  485:        test_connect_s2s_unauthenticated_iq,
<a name="486"/>  486:        test_auth_starttls]},
<a name="487"/>  487:      {s2s_tests, [sequence],
<a name="488"/>  488:       [test_missing_from,
<a name="489"/>  489:        test_missing_to,
<a name="490"/>  490:        test_invalid_from,
<a name="491"/>  491:        bad_nonza,
<a name="492"/>  492:        codec_failure]}].
<a name="493"/>  493: 
<a name="groups-0"/><a name="494"/>  494: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="495"/>  495: <b>    [{ldap, [sequence], ldap_tests</b>()},
<a name="496"/>  496:      {extauth, [sequence], extauth_tests()},
<a name="497"/>  497:      {no_db, [sequence], no_db_tests()},
<a name="498"/>  498:      {component, [sequence], component_tests()},
<a name="499"/>  499:      {s2s, [sequence], s2s_tests()},
<a name="500"/>  500:      {mnesia, [sequence], db_tests(mnesia)},
<a name="501"/>  501:      {redis, [sequence], db_tests(redis)},
<a name="502"/>  502:      {mysql, [sequence], db_tests(mysql)},
<a name="503"/>  503:      {mssql, [sequence], db_tests(mssql)},
<a name="504"/>  504:      {pgsql, [sequence], db_tests(pgsql)},
<a name="505"/>  505:      {sqlite, [sequence], db_tests(sqlite)}].
<a name="506"/>  506: 
<a name="all-0"/><a name="507"/>  507: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="508"/>  508:     [{group, ldap},
<a name="509"/>  509:      {group, no_db},
<a name="510"/>  510:      {group, mnesia},
<a name="511"/>  511:      {group, redis},
<a name="512"/>  512:      {group, mysql},
<a name="513"/>  513:      {group, mssql},
<a name="514"/>  514:      {group, pgsql},
<a name="515"/>  515:      {group, sqlite},
<a name="516"/>  516:      {group, extauth},
<a name="517"/>  517:      {group, component},
<a name="518"/>  518:      {group, s2s},
<a name="519"/>  519:      stop_ejabberd].
<a name="520"/>  520: 
<a name="stop_ejabberd-1"/><a name="521"/>  521: <b>stop_ejabberd</b>(Config) -&gt;
<a name="522"/>  522:     ok = application:stop(ejabberd),
<a name="523"/>  523:     ?recv1(#stream_error{reason = 'system-shutdown'}),
<a name="524"/>  524:     case suite:recv(Config) of
<a name="525"/>  525:         {xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;} -&gt;
<a name="526"/>  526:             ok;
<a name="527"/>  527:         closed -&gt;
<a name="528"/>  528:             ok;
<a name="529"/>  529:         Other -&gt;
<a name="530"/>  530:             suite:match_failure([Other], [closed])
<a name="531"/>  531:     end,
<a name="stop_ejabberd-last_expr"/><a name="532"/>  532:     Config.
<a name="533"/>  533: 
<a name="test_connect_bad_xml-1"/><a name="534"/>  534: <b>test_connect_bad_xml</b>(Config) -&gt;
<a name="535"/>  535:     Config0 = tcp_connect(Config),
<a name="536"/>  536:     send_text(Config0, &lt;&lt;&quot;&lt;'/&gt;&quot;&gt;&gt;),
<a name="537"/>  537:     Version = ?config(stream_version, Config0),
<a name="538"/>  538:     ?recv1(#stream_start{version = Version}),
<a name="539"/>  539:     ?recv1(#stream_error{reason = 'not-well-formed'}),
<a name="540"/>  540:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_bad_xml-last_expr"/><a name="541"/>  541: <b>    close_socket</b>(Config0).
<a name="542"/>  542: 
<a name="test_connect_unexpected_xml-1"/><a name="543"/>  543: <b>test_connect_unexpected_xml</b>(Config) -&gt;
<a name="544"/>  544:     Config0 = tcp_connect(Config),
<a name="545"/>  545:     send(Config0, #caps{}),
<a name="546"/>  546:     Version = ?config(stream_version, Config0),
<a name="547"/>  547:     ?recv1(#stream_start{version = Version}),
<a name="548"/>  548:     ?recv1(#stream_error{reason = 'invalid-xml'}),
<a name="549"/>  549:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_unexpected_xml-last_expr"/><a name="550"/>  550: <b>    close_socket</b>(Config0).
<a name="551"/>  551: 
<a name="test_connect_unknown_ns-1"/><a name="552"/>  552: <b>test_connect_unknown_ns</b>(Config) -&gt;
<a name="553"/>  553:     Config0 = init_stream(set_opt(xmlns, &lt;&lt;&quot;wrong&quot;&gt;&gt;, Config)),
<a name="554"/>  554:     ?recv1(#stream_error{reason = 'invalid-xml'}),
<a name="555"/>  555:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_unknown_ns-last_expr"/><a name="556"/>  556: <b>    close_socket</b>(Config0).
<a name="557"/>  557: 
<a name="test_connect_bad_xmlns-1"/><a name="558"/>  558: <b>test_connect_bad_xmlns</b>(Config) -&gt;
<a name="559"/>  559:     NS = case ?config(type, Config) of
<a name="560"/>  560: 	     client -&gt; ?NS_SERVER;
<a name="561"/>  561: 	     _ -&gt; ?NS_CLIENT
<a name="562"/>  562: 	 end,
<a name="563"/>  563:     Config0 = init_stream(set_opt(xmlns, NS, Config)),
<a name="564"/>  564:     ?recv1(#stream_error{reason = 'invalid-namespace'}),
<a name="565"/>  565:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_bad_xmlns-last_expr"/><a name="566"/>  566: <b>    close_socket</b>(Config0).
<a name="567"/>  567: 
<a name="test_connect_bad_ns_stream-1"/><a name="568"/>  568: <b>test_connect_bad_ns_stream</b>(Config) -&gt;
<a name="569"/>  569:     Config0 = init_stream(set_opt(ns_stream, &lt;&lt;&quot;wrong&quot;&gt;&gt;, Config)),
<a name="570"/>  570:     ?recv1(#stream_error{reason = 'invalid-namespace'}),
<a name="571"/>  571:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_bad_ns_stream-last_expr"/><a name="572"/>  572: <b>    close_socket</b>(Config0).
<a name="573"/>  573: 
<a name="test_connect_bad_lang-1"/><a name="574"/>  574: <b>test_connect_bad_lang</b>(Config) -&gt;
<a name="575"/>  575:     Lang = iolist_to_binary(lists:duplicate(36, $x)),
<a name="576"/>  576:     Config0 = init_stream(set_opt(lang, Lang, Config)),
<a name="577"/>  577:     ?recv1(#stream_error{reason = 'invalid-xml'}),
<a name="578"/>  578:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_bad_lang-last_expr"/><a name="579"/>  579: <b>    close_socket</b>(Config0).
<a name="580"/>  580: 
<a name="test_connect_bad_to-1"/><a name="581"/>  581: <b>test_connect_bad_to</b>(Config) -&gt;
<a name="582"/>  582:     Config0 = init_stream(set_opt(server, &lt;&lt;&quot;wrong.com&quot;&gt;&gt;, Config)),
<a name="583"/>  583:     ?recv1(#stream_error{reason = 'host-unknown'}),
<a name="584"/>  584:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_bad_to-last_expr"/><a name="585"/>  585: <b>    close_socket</b>(Config0).
<a name="586"/>  586: 
<a name="test_connect_missing_to-1"/><a name="587"/>  587: <b>test_connect_missing_to</b>(Config) -&gt;
<a name="588"/>  588:     Config0 = init_stream(set_opt(server, &lt;&lt;&quot;&quot;&gt;&gt;, Config)),
<a name="589"/>  589:     ?recv1(#stream_error{reason = 'improper-addressing'}),
<a name="590"/>  590:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_missing_to-last_expr"/><a name="591"/>  591: <b>    close_socket</b>(Config0).
<a name="592"/>  592: 
<a name="test_connect-1"/><a name="593"/>  593: <b>test_connect</b>(Config) -&gt;
<a name="test_connect-last_expr"/><a name="594"/>  594: <b>    disconnect</b>(connect(Config)).
<a name="595"/>  595: 
<a name="test_connect_s2s_starttls_required-1"/><a name="596"/>  596: <b>test_connect_s2s_starttls_required</b>(Config) -&gt;
<a name="597"/>  597:     Config1 = connect(Config),
<a name="598"/>  598:     send(Config1, #presence{}),
<a name="599"/>  599:     ?recv1(#stream_error{reason = 'policy-violation'}),
<a name="600"/>  600:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_connect_s2s_starttls_required-last_expr"/><a name="601"/>  601: <b>    close_socket</b>(Config1).
<a name="602"/>  602: 
<a name="test_connect_s2s_unauthenticated_iq-1"/><a name="603"/>  603: <b>test_connect_s2s_unauthenticated_iq</b>(Config) -&gt;
<a name="604"/>  604:     Config1 = connect(starttls(connect(Config))),
<a name="test_connect_s2s_unauthenticated_iq-last_expr"/><a name="605"/>  605: <b>    unauthenticated_iq</b>(Config1).
<a name="606"/>  606: 
<a name="test_starttls-1"/><a name="607"/>  607: <b>test_starttls</b>(Config) -&gt;
<a name="test_starttls-last_expr"/><a name="608"/>  608: <b>    case ?config</b>(starttls, Config) of
<a name="609"/>  609:         true -&gt;
<a name="610"/>  610:             disconnect(connect(starttls(Config)));
<a name="611"/>  611:         _ -&gt;
<a name="612"/>  612:             {skipped, 'starttls_not_available'}
<a name="613"/>  613:     end.
<a name="614"/>  614: 
<a name="test_zlib-1"/><a name="615"/>  615: <b>test_zlib</b>(Config) -&gt;
<a name="test_zlib-last_expr"/><a name="616"/>  616: <b>    case ?config</b>(compression, Config) of
<a name="617"/>  617:         [_|_] = Ms -&gt;
<a name="618"/>  618:             case lists:member(&lt;&lt;&quot;zlib&quot;&gt;&gt;, Ms) of
<a name="619"/>  619:                 true -&gt;
<a name="620"/>  620:                     disconnect(zlib(Config));
<a name="621"/>  621:                 false -&gt;
<a name="622"/>  622:                     {skipped, 'zlib_not_available'}
<a name="623"/>  623:             end;
<a name="624"/>  624:         _ -&gt;
<a name="625"/>  625:             {skipped, 'compression_not_available'}
<a name="626"/>  626:     end.
<a name="627"/>  627: 
<a name="test_register-1"/><a name="628"/>  628: <b>test_register</b>(Config) -&gt;
<a name="test_register-last_expr"/><a name="629"/>  629: <b>    case ?config</b>(register, Config) of
<a name="630"/>  630:         true -&gt;
<a name="631"/>  631:             disconnect(register(Config));
<a name="632"/>  632:         _ -&gt;
<a name="633"/>  633:             {skipped, 'registration_not_available'}
<a name="634"/>  634:     end.
<a name="635"/>  635: 
<a name="register-1"/><a name="636"/>  636: <b>register</b>(Config) -&gt;
<a name="637"/>  637:     #iq{type = result,
<a name="638"/>  638:         sub_els = [#register{username = &lt;&lt;&gt;&gt;,
<a name="639"/>  639:                              password = &lt;&lt;&gt;&gt;}]} =
<a name="640"/>  640:         send_recv(Config, #iq{type = get, to = server_jid(Config),
<a name="641"/>  641:                               sub_els = [#register{}]}),
<a name="642"/>  642:     #iq{type = result, sub_els = []} =
<a name="643"/>  643:         send_recv(
<a name="644"/>  644:           Config,
<a name="645"/>  645:           #iq{type = set,
<a name="646"/>  646:               sub_els = [#register{username = ?config(user, Config),
<a name="647"/>  647:                                    password = ?config(password, Config)}]}),
<a name="register-last_expr"/><a name="648"/>  648:     Config.
<a name="649"/>  649: 
<a name="test_unregister-1"/><a name="650"/>  650: <b>test_unregister</b>(Config) -&gt;
<a name="test_unregister-last_expr"/><a name="651"/>  651: <b>    case ?config</b>(register, Config) of
<a name="652"/>  652:         true -&gt;
<a name="653"/>  653:             try_unregister(Config);
<a name="654"/>  654:         _ -&gt;
<a name="655"/>  655:             {skipped, 'registration_not_available'}
<a name="656"/>  656:     end.
<a name="657"/>  657: 
<a name="try_unregister-1"/><a name="658"/>  658: <b>try_unregister</b>(Config) -&gt;
<a name="659"/>  659:     true = is_feature_advertised(Config, ?NS_REGISTER),
<a name="660"/>  660:     #iq{type = result, sub_els = []} =
<a name="661"/>  661:         send_recv(
<a name="662"/>  662:           Config,
<a name="663"/>  663:           #iq{type = set,
<a name="664"/>  664:               sub_els = [#register{remove = true}]}),
<a name="665"/>  665:     ?recv1(#stream_error{reason = conflict}),
<a name="try_unregister-last_expr"/><a name="666"/>  666:     Config.
<a name="667"/>  667: 
<a name="unauthenticated_presence-1"/><a name="668"/>  668: <b>unauthenticated_presence</b>(Config) -&gt;
<a name="unauthenticated_presence-last_expr"/><a name="669"/>  669: <b>    unauthenticated_packet</b>(Config, #presence{}).
<a name="670"/>  670: 
<a name="unauthenticated_message-1"/><a name="671"/>  671: <b>unauthenticated_message</b>(Config) -&gt;
<a name="unauthenticated_message-last_expr"/><a name="672"/>  672: <b>    unauthenticated_packet</b>(Config, #message{}).
<a name="673"/>  673: 
<a name="unauthenticated_iq-1"/><a name="674"/>  674: <b>unauthenticated_iq</b>(Config) -&gt;
<a name="675"/>  675:     IQ = #iq{type = get, sub_els = [#disco_info{}]},
<a name="unauthenticated_iq-last_expr"/><a name="676"/>  676: <b>    unauthenticated_packet</b>(Config, IQ).
<a name="677"/>  677: 
<a name="unauthenticated_packet-2"/><a name="678"/>  678: <b>unauthenticated_packet</b>(Config, Pkt) -&gt;
<a name="679"/>  679:     From = my_jid(Config),
<a name="680"/>  680:     To = server_jid(Config),
<a name="681"/>  681:     send(Config, xmpp:set_from_to(Pkt, From, To)),
<a name="682"/>  682:     #stream_error{reason = 'not-authorized'} = recv(Config),
<a name="683"/>  683:     {xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;} = recv(Config),
<a name="unauthenticated_packet-last_expr"/><a name="684"/>  684: <b>    close_socket</b>(Config).
<a name="685"/>  685: 
<a name="bad_nonza-1"/><a name="686"/>  686: <b>bad_nonza</b>(Config) -&gt;
<a name="687"/>  687:     %% Unsupported and invalid nonza should be silently dropped.
<a name="688"/>  688:     send(Config, #caps{}),
<a name="689"/>  689:     send(Config, #stanza_error{type = wrong}),
<a name="bad_nonza-last_expr"/><a name="690"/>  690: <b>    disconnect</b>(Config).
<a name="691"/>  691: 
<a name="invalid_from-1"/><a name="692"/>  692: <b>invalid_from</b>(Config) -&gt;
<a name="693"/>  693:     send(Config, #message{from = jid:make(p1_rand:get_string())}),
<a name="694"/>  694:     ?recv1(#stream_error{reason = 'invalid-from'}),
<a name="695"/>  695:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="invalid_from-last_expr"/><a name="696"/>  696: <b>    close_socket</b>(Config).
<a name="697"/>  697: 
<a name="test_missing_from-1"/><a name="698"/>  698: <b>test_missing_from</b>(Config) -&gt;
<a name="699"/>  699:     Server = server_jid(Config),
<a name="700"/>  700:     send(Config, #message{to = Server}),
<a name="701"/>  701:     ?recv1(#stream_error{reason = 'improper-addressing'}),
<a name="702"/>  702:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_missing_from-last_expr"/><a name="703"/>  703: <b>    close_socket</b>(Config).
<a name="704"/>  704: 
<a name="test_missing_to-1"/><a name="705"/>  705: <b>test_missing_to</b>(Config) -&gt;
<a name="706"/>  706:     Server = server_jid(Config),
<a name="707"/>  707:     send(Config, #message{from = Server}),
<a name="708"/>  708:     ?recv1(#stream_error{reason = 'improper-addressing'}),
<a name="709"/>  709:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_missing_to-last_expr"/><a name="710"/>  710: <b>    close_socket</b>(Config).
<a name="711"/>  711: 
<a name="test_invalid_from-1"/><a name="712"/>  712: <b>test_invalid_from</b>(Config) -&gt;
<a name="713"/>  713:     From = jid:make(p1_rand:get_string()),
<a name="714"/>  714:     To = jid:make(p1_rand:get_string()),
<a name="715"/>  715:     send(Config, #message{from = From, to = To}),
<a name="716"/>  716:     ?recv1(#stream_error{reason = 'invalid-from'}),
<a name="717"/>  717:     ?recv1({xmlstreamend, &lt;&lt;&quot;stream:stream&quot;&gt;&gt;}),
<a name="test_invalid_from-last_expr"/><a name="718"/>  718: <b>    close_socket</b>(Config).
<a name="719"/>  719: 
<a name="test_component_send-1"/><a name="720"/>  720: <b>test_component_send</b>(Config) -&gt;
<a name="721"/>  721:     To = jid:make(?COMMON_VHOST),
<a name="722"/>  722:     From = server_jid(Config),
<a name="723"/>  723:     #iq{type = result, from = To, to = From} =
<a name="724"/>  724: 	send_recv(Config, #iq{type = get, to = To, from = From,
<a name="725"/>  725: 			      sub_els = [#ping{}]}),
<a name="test_component_send-last_expr"/><a name="726"/>  726: <b>    disconnect</b>(Config).
<a name="727"/>  727: 
<a name="s2s_dialback-1"/><a name="728"/>  728: <b>s2s_dialback</b>(Config) -&gt;
<a name="729"/>  729:     Server = ?config(server, Config),
<a name="730"/>  730:     ejabberd_s2s:stop_s2s_connections(),
<a name="731"/>  731:     ejabberd_config:set_option({s2s_use_starttls, Server}, false),
<a name="732"/>  732:     ejabberd_config:set_option({s2s_use_starttls, ?MNESIA_VHOST}, false),
<a name="733"/>  733:     ejabberd_config:set_option(ca_file, pkix:get_cafile()),
<a name="s2s_dialback-last_expr"/><a name="734"/>  734: <b>    s2s_ping</b>(Config).
<a name="735"/>  735: 
<a name="s2s_optional-1"/><a name="736"/>  736: <b>s2s_optional</b>(Config) -&gt;
<a name="737"/>  737:     Server = ?config(server, Config),
<a name="738"/>  738:     ejabberd_s2s:stop_s2s_connections(),
<a name="739"/>  739:     ejabberd_config:set_option({s2s_use_starttls, Server}, optional),
<a name="740"/>  740:     ejabberd_config:set_option({s2s_use_starttls, ?MNESIA_VHOST}, optional),
<a name="741"/>  741:     ejabberd_config:set_option(ca_file, pkix:get_cafile()),
<a name="s2s_optional-last_expr"/><a name="742"/>  742: <b>    s2s_ping</b>(Config).
<a name="743"/>  743: 
<a name="s2s_required-1"/><a name="744"/>  744: <b>s2s_required</b>(Config) -&gt;
<a name="745"/>  745:     Server = ?config(server, Config),
<a name="746"/>  746:     ejabberd_s2s:stop_s2s_connections(),
<a name="747"/>  747:     gen_mod:stop_module(Server, mod_s2s_dialback),
<a name="748"/>  748:     gen_mod:stop_module(?MNESIA_VHOST, mod_s2s_dialback),
<a name="749"/>  749:     ejabberd_config:set_option({s2s_use_starttls, Server}, required),
<a name="750"/>  750:     ejabberd_config:set_option({s2s_use_starttls, ?MNESIA_VHOST}, required),
<a name="751"/>  751:     ejabberd_config:set_option(ca_file, &quot;ca.pem&quot;),
<a name="s2s_required-last_expr"/><a name="752"/>  752: <b>    s2s_ping</b>(Config).
<a name="753"/>  753: 
<a name="s2s_ping-1"/><a name="754"/>  754: <b>s2s_ping</b>(Config) -&gt;
<a name="755"/>  755:     From = my_jid(Config),
<a name="756"/>  756:     To = jid:make(?MNESIA_VHOST),
<a name="757"/>  757:     ID = p1_rand:get_string(),
<a name="758"/>  758:     ejabberd_s2s:route(#iq{from = From, to = To, id = ID,
<a name="759"/>  759: 			   type = get, sub_els = [#ping{}]}),
<a name="760"/>  760:     #iq{type = result, id = ID, sub_els = []} = recv_iq(Config),
<a name="s2s_ping-last_expr"/><a name="761"/>  761: <b>    disconnect</b>(Config).
<a name="762"/>  762: 
<a name="auth_md5-1"/><a name="763"/>  763: <b>auth_md5</b>(Config) -&gt;
<a name="764"/>  764:     Mechs = ?config(mechs, Config),
<a name="auth_md5-last_expr"/><a name="765"/>  765: <b>    case lists:member</b>(&lt;&lt;&quot;DIGEST-MD5&quot;&gt;&gt;, Mechs) of
<a name="766"/>  766:         true -&gt;
<a name="767"/>  767:             disconnect(auth_SASL(&lt;&lt;&quot;DIGEST-MD5&quot;&gt;&gt;, Config));
<a name="768"/>  768:         false -&gt;
<a name="769"/>  769:             disconnect(Config),
<a name="770"/>  770:             {skipped, 'DIGEST-MD5_not_available'}
<a name="771"/>  771:     end.
<a name="772"/>  772: 
<a name="auth_plain-1"/><a name="773"/>  773: <b>auth_plain</b>(Config) -&gt;
<a name="774"/>  774:     Mechs = ?config(mechs, Config),
<a name="auth_plain-last_expr"/><a name="775"/>  775: <b>    case lists:member</b>(&lt;&lt;&quot;PLAIN&quot;&gt;&gt;, Mechs) of
<a name="776"/>  776:         true -&gt;
<a name="777"/>  777:             disconnect(auth_SASL(&lt;&lt;&quot;PLAIN&quot;&gt;&gt;, Config));
<a name="778"/>  778:         false -&gt;
<a name="779"/>  779:             disconnect(Config),
<a name="780"/>  780:             {skipped, 'PLAIN_not_available'}
<a name="781"/>  781:     end.
<a name="782"/>  782: 
<a name="auth_external-1"/><a name="783"/>  783: <b>auth_external</b>(Config0) -&gt;
<a name="784"/>  784:     Config = connect(starttls(Config0)),
<a name="auth_external-last_expr"/><a name="785"/>  785: <b>    disconnect</b>(auth_SASL(&lt;&lt;&quot;EXTERNAL&quot;&gt;&gt;, Config)).
<a name="786"/>  786: 
<a name="auth_external_no_jid-1"/><a name="787"/>  787: <b>auth_external_no_jid</b>(Config0) -&gt;
<a name="788"/>  788:     Config = connect(starttls(Config0)),
<a name="auth_external_no_jid-last_expr"/><a name="789"/>  789: <b>    disconnect</b>(auth_SASL(&lt;&lt;&quot;EXTERNAL&quot;&gt;&gt;, Config, _ShoudFail = false,
<a name="790"/>  790: 			 {&lt;&lt;&quot;&quot;&gt;&gt;, &lt;&lt;&quot;&quot;&gt;&gt;, &lt;&lt;&quot;&quot;&gt;&gt;})).
<a name="791"/>  791: 
<a name="auth_external_no_user-1"/><a name="792"/>  792: <b>auth_external_no_user</b>(Config0) -&gt;
<a name="793"/>  793:     Config = set_opt(user, &lt;&lt;&quot;&quot;&gt;&gt;, connect(starttls(Config0))),
<a name="auth_external_no_user-last_expr"/><a name="794"/>  794: <b>    disconnect</b>(auth_SASL(&lt;&lt;&quot;EXTERNAL&quot;&gt;&gt;, Config)).
<a name="795"/>  795: 
<a name="auth_external_malformed_jid-1"/><a name="796"/>  796: <b>auth_external_malformed_jid</b>(Config0) -&gt;
<a name="797"/>  797:     Config = connect(starttls(Config0)),
<a name="auth_external_malformed_jid-last_expr"/><a name="798"/>  798: <b>    disconnect</b>(auth_SASL(&lt;&lt;&quot;EXTERNAL&quot;&gt;&gt;, Config, _ShouldFail = true,
<a name="799"/>  799: 			 {&lt;&lt;&quot;&quot;&gt;&gt;, &lt;&lt;&quot;@&quot;&gt;&gt;, &lt;&lt;&quot;&quot;&gt;&gt;})).
<a name="800"/>  800: 
<a name="auth_external_wrong_jid-1"/><a name="801"/>  801: <b>auth_external_wrong_jid</b>(Config0) -&gt;
<a name="802"/>  802:     Config = set_opt(user, &lt;&lt;&quot;wrong&quot;&gt;&gt;,
<a name="803"/>  803: 		     connect(starttls(Config0))),
<a name="auth_external_wrong_jid-last_expr"/><a name="804"/>  804: <b>    disconnect</b>(auth_SASL(&lt;&lt;&quot;EXTERNAL&quot;&gt;&gt;, Config, _ShouldFail = true)).
<a name="805"/>  805: 
<a name="auth_external_wrong_server-1"/><a name="806"/>  806: <b>auth_external_wrong_server</b>(Config0) -&gt;
<a name="807"/>  807:     Config = connect(starttls(Config0)),
<a name="auth_external_wrong_server-last_expr"/><a name="808"/>  808: <b>    disconnect</b>(auth_SASL(&lt;&lt;&quot;EXTERNAL&quot;&gt;&gt;, Config, _ShouldFail = true,
<a name="809"/>  809: 			 {&lt;&lt;&quot;&quot;&gt;&gt;, &lt;&lt;&quot;wrong.com&quot;&gt;&gt;, &lt;&lt;&quot;&quot;&gt;&gt;})).
<a name="810"/>  810: 
<a name="auth_external_invalid_cert-1"/><a name="811"/>  811: <b>auth_external_invalid_cert</b>(Config0) -&gt;
<a name="812"/>  812:     Config = connect(starttls(
<a name="813"/>  813: 		       set_opt(certfile, &quot;self-signed-cert.pem&quot;, Config0))),
<a name="auth_external_invalid_cert-last_expr"/><a name="814"/>  814: <b>    disconnect</b>(auth_SASL(&lt;&lt;&quot;EXTERNAL&quot;&gt;&gt;, Config, _ShouldFail = true)).
<a name="815"/>  815: 
<a name="test_legacy_auth_feature-1"/><a name="816"/>  816: <b>test_legacy_auth_feature</b>(Config) -&gt;
<a name="817"/>  817:     true = ?config(legacy_auth, Config),
<a name="test_legacy_auth_feature-last_expr"/><a name="818"/>  818: <b>    disconnect</b>(Config).
<a name="819"/>  819: 
<a name="test_legacy_auth-1"/><a name="820"/>  820: <b>test_legacy_auth</b>(Config) -&gt;
<a name="test_legacy_auth-last_expr"/><a name="821"/>  821: <b>    disconnect</b>(auth_legacy(Config, _Digest = false)).
<a name="822"/>  822: 
<a name="test_legacy_auth_digest-1"/><a name="823"/>  823: <b>test_legacy_auth_digest</b>(Config) -&gt;
<a name="test_legacy_auth_digest-last_expr"/><a name="824"/>  824: <b>    disconnect</b>(auth_legacy(Config, _Digest = true)).
<a name="825"/>  825: 
<a name="test_legacy_auth_no_resource-1"/><a name="826"/>  826: <b>test_legacy_auth_no_resource</b>(Config0) -&gt;
<a name="827"/>  827:     Config = set_opt(resource, &lt;&lt;&quot;&quot;&gt;&gt;, Config0),
<a name="test_legacy_auth_no_resource-last_expr"/><a name="828"/>  828: <b>    disconnect</b>(auth_legacy(Config, _Digest = false, _ShouldFail = true)).
<a name="829"/>  829: 
<a name="test_legacy_auth_bad_jid-1"/><a name="830"/>  830: <b>test_legacy_auth_bad_jid</b>(Config0) -&gt;
<a name="831"/>  831:     Config = set_opt(user, &lt;&lt;&quot;@&quot;&gt;&gt;, Config0),
<a name="test_legacy_auth_bad_jid-last_expr"/><a name="832"/>  832: <b>    disconnect</b>(auth_legacy(Config, _Digest = false, _ShouldFail = true)).
<a name="833"/>  833: 
<a name="test_legacy_auth_fail-1"/><a name="834"/>  834: <b>test_legacy_auth_fail</b>(Config0) -&gt;
<a name="835"/>  835:     Config = set_opt(user, &lt;&lt;&quot;wrong&quot;&gt;&gt;, Config0),
<a name="test_legacy_auth_fail-last_expr"/><a name="836"/>  836: <b>    disconnect</b>(auth_legacy(Config, _Digest = false, _ShouldFail = true)).
<a name="837"/>  837: 
<a name="test_auth-1"/><a name="838"/>  838: <b>test_auth</b>(Config) -&gt;
<a name="test_auth-last_expr"/><a name="839"/>  839: <b>    disconnect</b>(auth(Config)).
<a name="840"/>  840: 
<a name="test_auth_starttls-1"/><a name="841"/>  841: <b>test_auth_starttls</b>(Config) -&gt;
<a name="test_auth_starttls-last_expr"/><a name="842"/>  842: <b>    disconnect</b>(auth(connect(starttls(Config)))).
<a name="843"/>  843: 
<a name="test_auth_fail-1"/><a name="844"/>  844: <b>test_auth_fail</b>(Config0) -&gt;
<a name="845"/>  845:     Config = set_opt(user, &lt;&lt;&quot;wrong&quot;&gt;&gt;,
<a name="846"/>  846: 		     set_opt(password, &lt;&lt;&quot;wrong&quot;&gt;&gt;, Config0)),
<a name="test_auth_fail-last_expr"/><a name="847"/>  847: <b>    disconnect</b>(auth(Config, _ShouldFail = true)).
<a name="848"/>  848: 
<a name="test_bind-1"/><a name="849"/>  849: <b>test_bind</b>(Config) -&gt;
<a name="test_bind-last_expr"/><a name="850"/>  850: <b>    disconnect</b>(bind(Config)).
<a name="851"/>  851: 
<a name="test_open_session-1"/><a name="852"/>  852: <b>test_open_session</b>(Config) -&gt;
<a name="test_open_session-last_expr"/><a name="853"/>  853: <b>    disconnect</b>(open_session(Config, true)).
<a name="854"/>  854: 
<a name="codec_failure-1"/><a name="855"/>  855: <b>codec_failure</b>(Config) -&gt;
<a name="856"/>  856:     JID = my_jid(Config),
<a name="857"/>  857:     #iq{type = error} =
<a name="858"/>  858: 	send_recv(Config, #iq{type = wrong, from = JID, to = JID}),
<a name="codec_failure-last_expr"/><a name="859"/>  859: <b>    disconnect</b>(Config).
<a name="860"/>  860: 
<a name="unsupported_query-1"/><a name="861"/>  861: <b>unsupported_query</b>(Config) -&gt;
<a name="862"/>  862:     ServerJID = server_jid(Config),
<a name="863"/>  863:     #iq{type = error} = send_recv(Config, #iq{type = get, to = ServerJID}),
<a name="864"/>  864:     #iq{type = error} = send_recv(Config, #iq{type = get, to = ServerJID,
<a name="865"/>  865: 					      sub_els = [#caps{}]}),
<a name="866"/>  866:     #iq{type = error} = send_recv(Config, #iq{type = get, to = ServerJID,
<a name="867"/>  867: 					      sub_els = [#roster_query{},
<a name="868"/>  868: 							 #disco_info{},
<a name="869"/>  869: 							 #privacy_query{}]}),
<a name="unsupported_query-last_expr"/><a name="870"/>  870: <b>    disconnect</b>(Config).
<a name="871"/>  871: 
<a name="presence-1"/><a name="872"/>  872: <b>presence</b>(Config) -&gt;
<a name="873"/>  873:     JID = my_jid(Config),
<a name="874"/>  874:     #presence{from = JID, to = JID} = send_recv(Config, #presence{}),
<a name="presence-last_expr"/><a name="875"/>  875: <b>    disconnect</b>(Config).
<a name="876"/>  876: 
<a name="presence_broadcast-1"/><a name="877"/>  877: <b>presence_broadcast</b>(Config) -&gt;
<a name="878"/>  878:     Feature = &lt;&lt;&quot;p1:tmp:&quot;, (p1_rand:get_string())/binary&gt;&gt;,
<a name="879"/>  879:     Ver = crypto:hash(sha, [&quot;client&quot;, $/, &quot;bot&quot;, $/, &quot;en&quot;, $/,
<a name="880"/>  880:                             &quot;ejabberd_ct&quot;, $&lt;, Feature, $&lt;]),
<a name="881"/>  881:     B64Ver = base64:encode(Ver),
<a name="882"/>  882:     Node = &lt;&lt;(?EJABBERD_CT_URI)/binary, $#, B64Ver/binary&gt;&gt;,
<a name="883"/>  883:     Server = ?config(server, Config),
<a name="884"/>  884:     Info = #disco_info{identities =
<a name="885"/>  885: 			   [#identity{category = &lt;&lt;&quot;client&quot;&gt;&gt;,
<a name="886"/>  886: 				      type = &lt;&lt;&quot;bot&quot;&gt;&gt;,
<a name="887"/>  887: 				      lang = &lt;&lt;&quot;en&quot;&gt;&gt;,
<a name="888"/>  888: 				      name = &lt;&lt;&quot;ejabberd_ct&quot;&gt;&gt;}],
<a name="889"/>  889: 		       node = Node, features = [Feature]},
<a name="890"/>  890:     Caps = #caps{hash = &lt;&lt;&quot;sha-1&quot;&gt;&gt;, node = ?EJABBERD_CT_URI, version = B64Ver},
<a name="891"/>  891:     send(Config, #presence{sub_els = [Caps]}),
<a name="892"/>  892:     JID = my_jid(Config),
<a name="893"/>  893:     %% We receive:
<a name="894"/>  894:     %% 1) disco#info iq request for CAPS
<a name="895"/>  895:     %% 2) welcome message
<a name="896"/>  896:     %% 3) presence broadcast
<a name="897"/>  897:     IQ = #iq{type = get,
<a name="898"/>  898: 	     from = JID,
<a name="899"/>  899: 	     sub_els = [#disco_info{node = Node}]} = recv_iq(Config),
<a name="900"/>  900:     #message{type = normal} = recv_message(Config),
<a name="901"/>  901:     #presence{from = JID, to = JID} = recv_presence(Config),
<a name="902"/>  902:     send(Config, #iq{type = result, id = IQ#iq.id,
<a name="903"/>  903: 		     to = JID, sub_els = [Info]}),
<a name="904"/>  904:     %% We're trying to read our feature from ejabberd database
<a name="905"/>  905:     %% with exponential back-off as our IQ response may be delayed.
<a name="906"/>  906:     [Feature] =
<a name="907"/>  907: 	lists:foldl(
<a name="908"/>  908: 	  fun(Time, []) -&gt;
<a name="909"/>  909: 		  timer:sleep(Time),
<a name="910"/>  910: 		  mod_caps:get_features(Server, Caps);
<a name="911"/>  911: 	     (_, Acc) -&gt;
<a name="912"/>  912: 		  Acc
<a name="913"/>  913: 	  end, [], [0, 100, 200, 2000, 5000, 10000]),
<a name="presence_broadcast-last_expr"/><a name="914"/>  914: <b>    disconnect</b>(Config).
<a name="915"/>  915: 
<a name="ping-1"/><a name="916"/>  916: <b>ping</b>(Config) -&gt;
<a name="917"/>  917:     true = is_feature_advertised(Config, ?NS_PING),
<a name="918"/>  918:     #iq{type = result, sub_els = []} =
<a name="919"/>  919:         send_recv(
<a name="920"/>  920:           Config,
<a name="921"/>  921:           #iq{type = get, sub_els = [#ping{}], to = server_jid(Config)}),
<a name="ping-last_expr"/><a name="922"/>  922: <b>    disconnect</b>(Config).
<a name="923"/>  923: 
<a name="version-1"/><a name="924"/>  924: <b>version</b>(Config) -&gt;
<a name="925"/>  925:     true = is_feature_advertised(Config, ?NS_VERSION),
<a name="926"/>  926:     #iq{type = result, sub_els = [#version{}]} =
<a name="927"/>  927:         send_recv(
<a name="928"/>  928:           Config, #iq{type = get, sub_els = [#version{}],
<a name="929"/>  929:                       to = server_jid(Config)}),
<a name="version-last_expr"/><a name="930"/>  930: <b>    disconnect</b>(Config).
<a name="931"/>  931: 
<a name="time-1"/><a name="932"/>  932: <b>time</b>(Config) -&gt;
<a name="933"/>  933:     true = is_feature_advertised(Config, ?NS_TIME),
<a name="934"/>  934:     #iq{type = result, sub_els = [#time{}]} =
<a name="935"/>  935:         send_recv(Config, #iq{type = get, sub_els = [#time{}],
<a name="936"/>  936:                               to = server_jid(Config)}),
<a name="time-last_expr"/><a name="937"/>  937: <b>    disconnect</b>(Config).
<a name="938"/>  938: 
<a name="disco-1"/><a name="939"/>  939: <b>disco</b>(Config) -&gt;
<a name="940"/>  940:     true = is_feature_advertised(Config, ?NS_DISCO_INFO),
<a name="941"/>  941:     true = is_feature_advertised(Config, ?NS_DISCO_ITEMS),
<a name="942"/>  942:     #iq{type = result, sub_els = [#disco_items{items = Items}]} =
<a name="943"/>  943:         send_recv(
<a name="944"/>  944:           Config, #iq{type = get, sub_els = [#disco_items{}],
<a name="945"/>  945:                       to = server_jid(Config)}),
<a name="946"/>  946:     lists:foreach(
<a name="947"/>  947:       fun(#disco_item{jid = JID, node = Node}) -&gt;
<a name="948"/>  948:               #iq{type = result} =
<a name="949"/>  949:                   send_recv(Config,
<a name="950"/>  950:                             #iq{type = get, to = JID,
<a name="951"/>  951:                                 sub_els = [#disco_info{node = Node}]})
<a name="952"/>  952:       end, Items),
<a name="disco-last_expr"/><a name="953"/>  953: <b>    disconnect</b>(Config).
<a name="954"/>  954: 
<a name="last-1"/><a name="955"/>  955: <b>last</b>(Config) -&gt;
<a name="956"/>  956:     true = is_feature_advertised(Config, ?NS_LAST),
<a name="957"/>  957:     #iq{type = result, sub_els = [#last{}]} =
<a name="958"/>  958:         send_recv(Config, #iq{type = get, sub_els = [#last{}],
<a name="959"/>  959:                               to = server_jid(Config)}),
<a name="last-last_expr"/><a name="960"/>  960: <b>    disconnect</b>(Config).
<a name="961"/>  961: 
<a name="vcard_get-1"/><a name="962"/>  962: <b>vcard_get</b>(Config) -&gt;
<a name="963"/>  963:     true = is_feature_advertised(Config, ?NS_VCARD),
<a name="964"/>  964:     %% TODO: check if VCard corresponds to LDIF data from ejabberd.ldif
<a name="965"/>  965:     #iq{type = result, sub_els = [_VCard]} =
<a name="966"/>  966:         send_recv(Config, #iq{type = get, sub_els = [#vcard_temp{}]}),
<a name="vcard_get-last_expr"/><a name="967"/>  967: <b>    disconnect</b>(Config).
<a name="968"/>  968: 
<a name="ldap_shared_roster_get-1"/><a name="969"/>  969: <b>ldap_shared_roster_get</b>(Config) -&gt;
<a name="970"/>  970:     Item = #roster_item{jid = jid:decode(&lt;&lt;&quot;user2@ldap.localhost&quot;&gt;&gt;), name = &lt;&lt;&quot;Test User 2&quot;&gt;&gt;,
<a name="971"/>  971:                         groups = [&lt;&lt;&quot;group1&quot;&gt;&gt;], subscription = both},
<a name="972"/>  972:     #iq{type = result, sub_els = [#roster_query{items = [Item]}]} =
<a name="973"/>  973:         send_recv(Config, #iq{type = get, sub_els = [#roster_query{}]}),
<a name="ldap_shared_roster_get-last_expr"/><a name="974"/>  974: <b>    disconnect</b>(Config).
<a name="975"/>  975: 
<a name="stats-1"/><a name="976"/>  976: <b>stats</b>(Config) -&gt;
<a name="977"/>  977:     #iq{type = result, sub_els = [#stats{list = Stats}]} =
<a name="978"/>  978:         send_recv(Config, #iq{type = get, sub_els = [#stats{}],
<a name="979"/>  979:                               to = server_jid(Config)}),
<a name="980"/>  980:     lists:foreach(
<a name="981"/>  981:       fun(#stat{} = Stat) -&gt;
<a name="982"/>  982:               #iq{type = result, sub_els = [_|_]} =
<a name="983"/>  983:                   send_recv(Config, #iq{type = get,
<a name="984"/>  984:                                         sub_els = [#stats{list = [Stat]}],
<a name="985"/>  985:                                         to = server_jid(Config)})
<a name="986"/>  986:       end, Stats),
<a name="stats-last_expr"/><a name="987"/>  987: <b>    disconnect</b>(Config).
<a name="988"/>  988: 
<a name="989"/>  989: <i>%%%===================================================================</i>
<a name="990"/>  990: <i>%%% Aux functions</i>
<a name="991"/>  991: <i>%%%===================================================================</i>
<a name="bookmark_conference-0"/><a name="992"/>  992: <b>bookmark_conference</b>() -&gt;
<a name="bookmark_conference-last_expr"/><a name="993"/>  993:     #bookmark_conference{name = &lt;&lt;&quot;Some name&quot;&gt;&gt;,
<a name="994"/>  994:                          autojoin = true,
<a name="995"/>  995:                          jid = jid:make(
<a name="996"/>  996:                                  &lt;&lt;&quot;some&quot;&gt;&gt;,
<a name="997"/>  997:                                  &lt;&lt;&quot;some.conference.org&quot;&gt;&gt;,
<a name="998"/>  998:                                  &lt;&lt;&gt;&gt;)}.
<a name="999"/>  999: 
<a name="$handle_undefined_function-2"/><a name="1000"/> 1000: <b>'$handle_undefined_function'</b>(F, [Config]) when is_list(Config) -&gt;
<a name="1001"/> 1001:     case re:split(atom_to_list(F), &quot;_&quot;, [{return, list}, {parts, 2}]) of
<a name="1002"/> 1002: 	[M, T] -&gt;
<a name="1003"/> 1003: 	    Module = list_to_atom(M ++ &quot;_tests&quot;),
<a name="1004"/> 1004: 	    Function = list_to_atom(T),
<a name="1005"/> 1005: 	    case erlang:function_exported(Module, Function, 1) of
<a name="1006"/> 1006: 		true -&gt;
<a name="1007"/> 1007: 		    Module:Function(Config);
<a name="1008"/> 1008: 		false -&gt;
<a name="1009"/> 1009: 		    erlang:error({undef, F})
<a name="1010"/> 1010: 	    end;
<a name="1011"/> 1011: 	_ -&gt;
<a name="1012"/> 1012: 	    erlang:error({undef, F})
<a name="1013"/> 1013:     end;
<a name="1014"/> 1014: <b>'$handle_undefined_function'</b>(_, _) -&gt;
<a name="$handle_undefined_function-last_expr"/><a name="1015"/> 1015: <b>    erlang:error</b>(undef).
<a name="1016"/> 1016: 
<a name="1017"/> 1017: 
<a name="1018"/> 1018: <i>%%%===================================================================</i>
<a name="1019"/> 1019: <i>%%% SQL stuff</i>
<a name="1020"/> 1020: <i>%%%===================================================================</i>
<a name="update_sql-2"/><a name="1021"/> 1021: <b>update_sql</b>(Host, Config) -&gt;
<a name="update_sql-last_expr"/><a name="1022"/> 1022: <b>    case ?config</b>(update_sql, Config) of
<a name="1023"/> 1023:         true -&gt;
<a name="1024"/> 1024:             mod_admin_update_sql:update_sql(Host);
<a name="1025"/> 1025:         false -&gt; ok
<a name="1026"/> 1026:     end.
<a name="1027"/> 1027: 
<a name="schema_suffix-1"/><a name="1028"/> 1028: <b>schema_suffix</b>(Config) -&gt;
<a name="schema_suffix-last_expr"/><a name="1029"/> 1029: <b>    case ejabberd_sql:use_new_schema</b>() of
<a name="1030"/> 1030:         true -&gt;
<a name="1031"/> 1031:             case ?config(update_sql, Config) of
<a name="1032"/> 1032:                 true -&gt;  &quot;.sql&quot;;
<a name="1033"/> 1033:                 _ -&gt; &quot;.new.sql&quot;
<a name="1034"/> 1034:             end;
<a name="1035"/> 1035:         _ -&gt; &quot;.sql&quot;
<a name="1036"/> 1036:     end.
<a name="1037"/> 1037: 
<a name="clear_sql_tables-2"/><a name="1038"/> 1038: <b>clear_sql_tables</b>(sqlite, _Config) -&gt;
<a name="1039"/> 1039:     ok;
<a name="1040"/> 1040: <b>clear_sql_tables</b>(Type, Config) -&gt;
<a name="1041"/> 1041:     BaseDir = ?config(base_dir, Config),
<a name="1042"/> 1042:     {VHost, File} = case Type of
<a name="1043"/> 1043:                         mysql -&gt; {?MYSQL_VHOST, &quot;mysql&quot; ++ schema_suffix(Config)};
<a name="1044"/> 1044:                         mssql -&gt; {?MSSQL_VHOST, &quot;mssql&quot; ++ schema_suffix(Config)};
<a name="1045"/> 1045:                         pgsql -&gt; {?PGSQL_VHOST, &quot;pg&quot; ++ schema_suffix(Config)}
<a name="1046"/> 1046:                     end,
<a name="1047"/> 1047:     SQLFile = filename:join([BaseDir, &quot;sql&quot;, File]),
<a name="1048"/> 1048:     CreationQueries = read_sql_queries(SQLFile),
<a name="1049"/> 1049:     ClearTableQueries = clear_table_queries(CreationQueries),
<a name="clear_sql_tables-last_expr"/><a name="1050"/> 1050: <b>    case ejabberd_sql:sql_transaction</b>(
<a name="1051"/> 1051:            VHost, ClearTableQueries) of
<a name="1052"/> 1052:         {atomic, ok} -&gt;
<a name="1053"/> 1053:             ok;
<a name="1054"/> 1054:         Err -&gt;
<a name="1055"/> 1055:             ct:fail({failed_to_clear_sql_tables, Type, Err})
<a name="1056"/> 1056:     end.
<a name="1057"/> 1057: 
<a name="read_sql_queries-1"/><a name="1058"/> 1058: <b>read_sql_queries</b>(File) -&gt;
<a name="read_sql_queries-last_expr"/><a name="1059"/> 1059: <b>    case file:open</b>(File, [read, binary]) of
<a name="1060"/> 1060:         {ok, Fd} -&gt;
<a name="1061"/> 1061:             read_lines(Fd, File, []);
<a name="1062"/> 1062:         Err -&gt;
<a name="1063"/> 1063:             ct:fail({open_file_failed, File, Err})
<a name="1064"/> 1064:     end.
<a name="1065"/> 1065: 
<a name="clear_table_queries-1"/><a name="1066"/> 1066: <b>clear_table_queries</b>(Queries) -&gt;
<a name="clear_table_queries-last_expr"/><a name="1067"/> 1067: <b>    lists:foldl</b>(
<a name="1068"/> 1068:       fun(Query, Acc) -&gt;
<a name="1069"/> 1069:               case split(str:to_lower(Query)) of
<a name="1070"/> 1070:                   [&lt;&lt;&quot;create&quot;&gt;&gt;, &lt;&lt;&quot;table&quot;&gt;&gt;, Table|_] -&gt;
<a name="1071"/> 1071:                       [&lt;&lt;&quot;DELETE FROM &quot;, Table/binary, &quot;;&quot;&gt;&gt;|Acc];
<a name="1072"/> 1072:                   _ -&gt;
<a name="1073"/> 1073:                       Acc
<a name="1074"/> 1074:               end
<a name="1075"/> 1075:       end, [], Queries).
<a name="1076"/> 1076: 
<a name="read_lines-3"/><a name="1077"/> 1077: <b>read_lines</b>(Fd, File, Acc) -&gt;
<a name="read_lines-last_expr"/><a name="1078"/> 1078: <b>    case file:read_line</b>(Fd) of
<a name="1079"/> 1079:         {ok, Line} -&gt;
<a name="1080"/> 1080:             NewAcc = case str:strip(str:strip(Line, both, $\r), both, $\n) of
<a name="1081"/> 1081:                          &lt;&lt;&quot;--&quot;, _/binary&gt;&gt; -&gt;
<a name="1082"/> 1082:                              Acc;
<a name="1083"/> 1083:                          &lt;&lt;&gt;&gt; -&gt;
<a name="1084"/> 1084:                              Acc;
<a name="1085"/> 1085:                          _ -&gt;
<a name="1086"/> 1086:                              [Line|Acc]
<a name="1087"/> 1087:                      end,
<a name="1088"/> 1088:             read_lines(Fd, File, NewAcc);
<a name="1089"/> 1089:         eof -&gt;
<a name="1090"/> 1090:             QueryList = str:tokens(list_to_binary(lists:reverse(Acc)), &lt;&lt;&quot;;&quot;&gt;&gt;),
<a name="1091"/> 1091:             lists:flatmap(
<a name="1092"/> 1092:               fun(Query) -&gt;
<a name="1093"/> 1093:                       case str:strip(str:strip(Query, both, $\r), both, $\n) of
<a name="1094"/> 1094:                           &lt;&lt;&gt;&gt; -&gt;
<a name="1095"/> 1095:                               [];
<a name="1096"/> 1096:                           Q -&gt;
<a name="1097"/> 1097:                               [&lt;&lt;Q/binary, $;&gt;&gt;]
<a name="1098"/> 1098:                       end
<a name="1099"/> 1099:               end, QueryList);
<a name="1100"/> 1100:         {error, _} = Err -&gt;
<a name="1101"/> 1101:             ct:fail({read_file_failed, File, Err})
<a name="1102"/> 1102:     end.
<a name="1103"/> 1103: 
<a name="split-1"/><a name="1104"/> 1104: <b>split</b>(Data) -&gt;
<a name="split-last_expr"/><a name="1105"/> 1105: <b>    lists:filter</b>(
<a name="1106"/> 1106:       fun(&lt;&lt;&gt;&gt;) -&gt;
<a name="1107"/> 1107:               false;
<a name="1108"/> 1108:          (_) -&gt;
<a name="1109"/> 1109:               true
<a name="1110"/> 1110:       end, re:split(Data, &lt;&lt;&quot;\s&quot;&gt;&gt;)).
</pre>
</body>
</html>
